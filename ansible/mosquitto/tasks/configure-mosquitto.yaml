#SPDX-License-Identifier: MIT-0
---
# tasks file for configuring mosquitto broker

###################################################
# Mosquitto file locations                        #
# Database  /var/lib/mosquitto/mosquitto.db       #
# Logs      /var/log/mosquitto/mosquitto.log      #
# Config    /etc/mosquitto/mosquitto.conf         #
# Service   /lib/systemd/system/mosquitto.service #
###################################################

# https://docs.ansible.com/ansible/latest/collections/ansible/builtin/file_module.html
- name: Allow all mosquitto group members to read log
  ansible.builtin.file:
    path: /var/log/mosquitto/mosquitto.log
    owner: mosquitto
    group: mosquitto
    mode: 0640
  tags: log_permissions

# https://docs.ansible.com/ansible/latest/collections/ansible/builtin/copy_module.html
- name: Copy mosquitto logrotate file
  ansible.builtin.copy:
    src: "{{ role_path }}/files/mosquitto.logrotate"
    dest: /etc/logrotate.d/mosquitto
    owner: root
    group: root
    mode: 0644
  tags: logrotate
  notify: Validate Mosquitto logrotate


# https://docs.ansible.com/ansible/latest/collections/ansible/builtin/copy_module.html
- name: Copy mosquitto service file
  ansible.builtin.copy:
    src: "{{ role_path }}/files/mosquitto.service"
    dest: /lib/systemd/system/mosquitto.service
    owner: root
    group: root
    mode: 0644
  tags: service_file
  notify: Reload Mosquitto configurations

# https://docs.ansible.com/ansible/latest/collections/ansible/builtin/copy_module.html
- name: Copy mosquitto.conf file
  ansible.builtin.copy:
    src: "{{ role_path }}/files/mosquitto.conf"
    dest: /etc/mosquitto/mosquitto.conf
    owner: root
    group: root
    mode: 0644
  tags: mosquitto_conf
  notify: Reload Mosquitto configurations
